# expand_group.yml
---
- name: Get subnets that belong to this group
  set_fact:
    group_subnets: >-
      {{
        all_subnets_info.resources
        | selectattr('name', 'search', ('^' + (group_name | regex_escape) + '-\\d{3}-snt$'))
        | list
      }}

- name: Skip if group has no subnets
  when: group_subnets | length == 0
  debug:
    msg: "Group {{ group_name }} has no subnets. Skipping."
  ignore_errors: yes

- name: Sort and pick the last subnet (highest number)
  when: group_subnets | length > 0
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"

- name: Extract number suffix
  when: group_subnets | length > 0
  set_fact:
    last_num_str: "{{ last_subnet.name | regex_search('\\-(\\d{3})-snt$', '\\1') }}"
    last_num: "{{ last_num_str | int }}"

- name: Compute next subnet name
  set_fact:
    new_num: "{{ '%03d' | format(last_num + 1) }}"
    new_name: "{{ group_name }}-{{ new_num }}-snt"

- name: Extract prefix length (/24,/23 etc.)
  set_fact:
    prefix: "{{ last_subnet.ip_cidr_range.split('/')[-1] | int }}"

- name: Compute utilization
  set_fact:
    used: "{{ last_subnet.used_ip_count | int }}"
    avail: "{{ last_subnet.available_ip_count | int }}"
    util_pct: "{{ ((used * 100) / (used + avail)) | float | round(2) }}"

- name: Show utilization
  debug:
    msg: "Group {{ group_name }}: {{ last_subnet.name }} → {{ util_pct }}% used"

- name: Stop here if below threshold
  when: util_pct < threshold
  debug:
    msg: "No expansion needed for {{ group_name }} ({{ util_pct }}% < {{ threshold }}%)"

# ---------------------------
# CIDR AUTO DETECTION
# ---------------------------

- name: Collect all CIDRs in VPC (manual + automated)
  when: util_pct >= threshold
  set_fact:
    vpc_cidrs: "{{ all_subnets_info.resources | map(attribute='ip_cidr_range') | list }}"

- name: Derive auto base CIDR (/16 from first two octets)
  when: util_pct >= threshold
  set_fact:
    last_ip: "{{ last_subnet.ip_cidr_range.split('/')[0] }}"
    octets: "{{ last_ip.split('.') }}"
    auto_base: "{{ octets[0] }}.{{ octets[1] }}.0.0/{{ auto_base_prefix }}"

- name: Generate all candidate subnets (/prefix)
  when: util_pct >= threshold
  set_fact:
    candidate_list: "{{ auto_base | ipaddr('subnet', prefix) }}"

- name: Remove CIDRs already used
  when: util_pct >= threshold
  set_fact:
    free_candidates: "{{ candidate_list | reject('ipaddr', vpc_cidrs) | list }}"

- name: Fail if no free CIDR
  when: util_pct >= threshold and free_candidates | length == 0
  fail:
    msg: "NO FREE CIDR available for {{ group_name }} inside {{ auto_base }}"

- name: Choose the FIRST free CIDR
  when: util_pct >= threshold
  set_fact:
    selected_cidr: "{{ free_candidates | first }}"

# ---------------------------
# SUBNET CREATION
# ---------------------------

- name: Create new subnet
  when: util_pct >= threshold
  google.cloud.gcp_compute_subnetwork:
    name: "{{ new_name }}"
    network: "{{ last_subnet.network.split('/') | first }}"
    region: "{{ last_subnet.region }}"
    ip_cidr_range: "{{ selected_cidr }}"
    project: "{{ gcp_project }}"
  register: result

- name: Confirm creation
  when: util_pct >= threshold
  debug:
    msg: "Created {{ new_name }} → {{ selected_cidr }}"
