---
# expand_group.yml — FINAL SAFE VERSION

###############################################################################
# 1. Collect subnets for this group
###############################################################################

- name: Collect subnets for this group
  set_fact:
    group_subnets: >-
      {{
        all_subnets.resources
        | selectattr('name', 'match', '^' + group_name + '-[0-9]{3}-snt$')
        | list
      }}

- name: Show group subnets
  debug:
    msg: "Group {{ group_name }} subnets: {{ group_subnets | map(attribute='name') | list }}"

###############################################################################
# 2. Skip if no subnets
###############################################################################

- name: Skip group when no subnets found
  when: group_subnets | length == 0
  debug:
    msg: "Skipping {{ group_name }} — no subnets found."

###############################################################################
# 3. Identify last subnet safely
###############################################################################

- name: Identify last subnet
  when: group_subnets | length > 0
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"

###############################################################################
# 4. Extract numeric suffix SAFELY
###############################################################################

- name: Extract numeric suffix list
  when: last_subnet is defined
  set_fact:
    suffix_list: "{{ last_subnet.name | regex_findall('-(\\d{3})-snt$') }}"

- name: Convert suffix to integer
  when: suffix_list | length > 0
  set_fact:
    last_num: "{{ suffix_list[0] | int }}"

###############################################################################
# 5. Build next subnet name (MUST BE SEPARATE TASKS)
###############################################################################

- name: Compute next subnet number
  when: last_num is defined
  set_fact:
    new_num: "{{ '%03d' | format(last_num + 1) }}"

- name: Build next subnet name
  when: new_num is defined
  set_fact:
    new_name: "{{ group_name }}-{{ new_num }}-snt"

- debug:
    msg: "Next subnet name will be {{ new_name }}"

###############################################################################
# 6. Extract CIDR details
###############################################################################

- name: Extract prefix length
  set_fact:
    prefix: "{{ last_subnet.ipCidrRange.split('/')[-1] | int }}"

###############################################################################
# 7. (Optional) STOP here for now
###############################################################################

- debug:
    msg: >
      Group {{ group_name }} evaluated successfully.
      Last subnet={{ last_subnet.name }},
      Next={{ new_name }},
      Prefix=/{{ prefix }}
