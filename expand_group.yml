---
# expand_group.yml â€” FINAL STABLE VERSION

###############################################################################
# 1) Collect subnets for this group
###############################################################################

- name: Collect subnets for this group
  set_fact:
    group_subnets: >-
      {{
        all_subnets.resources
        | selectattr('name', 'match', '^' + group_name + '-[0-9]{3}-snt$')
        | list
      }}

- debug:
    msg: "Group {{ group_name }} subnets: {{ group_subnets | map(attribute='name') | list }}"

###############################################################################
# 2) Skip if no subnets
###############################################################################

- name: Skip group if no subnets
  meta: end_host
  when: group_subnets | length == 0

###############################################################################
# 3) Identify LAST subnet safely
###############################################################################

- name: Identify last subnet
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"

###############################################################################
# 4) Extract suffix NUMBER (SAFE INT CONVERSION)
###############################################################################

- name: Extract numeric suffix as INTEGER
  set_fact:
    last_num: >-
      {{
        (
          last_subnet.name
          | regex_search('([0-9]{3})-snt$', '\\1')
        )
        | int
      }}

###############################################################################
# 5) Build next subnet name (NO STRING MATH)
###############################################################################

- name: Build next subnet name
  set_fact:
    next_num: "{{ '%03d' | format(last_num + 1) }}"
    new_subnet_name: "{{ group_name }}-{{ next_num }}-snt"

- debug:
    msg: "Next subnet name will be {{ new_subnet_name }}"

###############################################################################
# 6) Utilization check (placeholder)
###############################################################################

- name: Skip creation if utilization below threshold
  when: (last_subnet.used_ip_count | default(0)) < threshold
  meta: end_host

###############################################################################
# 7) CIDR calculation (example logic)
###############################################################################

- name: Derive prefix
  set_fact:
    prefix: "{{ last_subnet.ipCidrRange.split('/')[-1] | int }}"

- name: Derive base /16
  set_fact:
    base_cidr: >-
      {{
        last_subnet.ipCidrRange.split('.')[0]
      }}.{{ last_subnet.ipCidrRange.split('.')[1] }}.0.0/16

###############################################################################
# 8) Create subnet
###############################################################################

- name: Create new subnet
  google.cloud.gcp_compute_subnetwork:
    project: "{{ gcp_project }}"
    region: "{{ last_subnet.region.split('/')[-1] }}"
    network: "{{ last_subnet.network }}"
    name: "{{ new_subnet_name }}"
    ip_cidr_range: "{{ base_cidr | ipaddr('subnet', prefix) | difference(all_subnets.resources | map(attribute='ipCidrRange') | list) | first }}"
