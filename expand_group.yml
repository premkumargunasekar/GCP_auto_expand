---
# expand_group.yml — FINAL CLEAN VERSION (NO TYPE ERRORS)

###############################################################################
# 1) Collect subnets for this group
###############################################################################

- name: Collect subnets for this group
  set_fact:
    group_subnets: >-
      {{
        all_subnets.resources
        | selectattr('name', 'search', '^' ~ group_name ~ '-[0-9]{3}-snt$')
        | list
      }}

- name: Show group subnets
  debug:
    msg: "Group {{ group_name }} subnets: {{ group_subnets | map(attribute='name') | list }}"

###############################################################################
# 2) Skip group if no subnets
###############################################################################

- name: Skip group when no subnets found
  when: group_subnets | length == 0
  debug:
    msg: "Skipping {{ group_name }} — no subnets found"

###############################################################################
# 3) Identify last subnet safely
###############################################################################

- name: Identify last subnet
  when: group_subnets | length > 0
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"

###############################################################################
# 4) Extract suffix and CONVERT TO INTEGER (KEY FIX)
###############################################################################

- name: Extract numeric suffix as INTEGER
  when: group_subnets | length > 0
  set_fact:
    last_num: >-
      {{
        (last_subnet.name
        | regex_search('([0-9]{3})-snt$', '\\1'))
        | int
      }}

###############################################################################
# 5) Compute next subnet name (SAFE)
###############################################################################

- name: Compute next subnet name
  when: group_subnets | length > 0
  set_fact:
    new_num: "{{ '%03d' | format(last_num + 1) }}"
    new_name: "{{ group_name }}-{{ new_num }}-snt"

- debug:
    msg: "Next subnet name will be {{ new_name }}"

###############################################################################
# 6) Utilization check (safe defaults)
###############################################################################

- name: Calculate utilization
  when: group_subnets | length > 0
  set_fact:
    used: "{{ last_subnet.used_ip_count | default(0) }}"
    avail: "{{ last_subnet.available_ip_count | default(0) }}"
    util_pct: "{{ ((used * 100) / (used + avail)) | round(2) if (used + avail) > 0 else 0 }}"

- debug:
    msg: "Utilization for {{ last_subnet.name }} = {{ util_pct }}%"

###############################################################################
# 7) Stop if utilization below threshold
###############################################################################

- name: Skip expansion if utilization below threshold
  when: util_pct < threshold
  debug:
    msg: "Utilization {{ util_pct }}% < {{ threshold }}% → No expansion"

###############################################################################
# 8) CIDR selection (safe, auto)
###############################################################################

- name: Collect used CIDRs
  when: util_pct >= threshold
  set_fact:
    used_cidrs: "{{ all_subnets.resources | map(attribute='ipCidrRange') | list }}"

- name: Derive base /16 from last subnet
  when: util_pct >= threshold
  set_fact:
    base_cidr: >-
      {{
        last_subnet.ipCidrRange.split('.')[0]
      }}.{{ last_subnet.ipCidrRange.split('.')[1] }}.0.0/{{ auto_base_prefix }}

- name: Generate candidate subnets
  when: util_pct >= threshold
  set_fact:
    candidates: "{{ base_cidr | ipaddr('subnet', last_subnet.ipCidrRange.split('/')[-1] | int) }}"

- name: Pick free CIDR
  when: util_pct >= threshold
  set_fact:
    selected_cidr: "{{ candidates | reject('ipaddr', used_cidrs) | list | first }}"

- name: Fail if no CIDR available
  when: util_pct >= threshold and selected_cidr is not defined
  fail:
    msg: "No free CIDR available for {{ group_name }}"

###############################################################################
# 9) Create subnet
###############################################################################

- name: Create subnet
  when: util_pct >= threshold
  google.cloud.gcp_compute_subnetwork:
    name: "{{ new_name }}"
    network: "{{ last_subnet.network.split('/') | last }}"
    region: "{{ last_subnet.region.split('/') | last }}"
    ip_cidr_range: "{{ selected_cidr }}"
    project: "{{ gcp_project }}"

- debug:
    msg: "Subnet {{ new_name }} created with CIDR {{ selected_cidr }}"
