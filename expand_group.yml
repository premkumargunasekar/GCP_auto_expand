---
# expand_group.yml â€” FINAL STABLE VERSION (AWX SAFE)

###############################################################################
# 1) Collect subnets for this group
###############################################################################

- name: Collect subnets for this group
  set_fact:
    group_subnets: >-
      {{
        all_subnets.resources
        | selectattr('name', 'search', '^' ~ group_name ~ '-[0-9]{3}-snt$')
        | list
      }}

- name: Show group subnets
  debug:
    msg: "Group {{ group_name }} subnets: {{ group_subnets | map(attribute='name') | list }}"

###############################################################################
# 2) Skip group if empty
###############################################################################

- name: Skip group if no subnets
  meta: end_host
  when: group_subnets | length == 0

###############################################################################
# 3) Identify last subnet (sorted)
###############################################################################

- name: Identify last subnet
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"

###############################################################################
# 4) SAFE suffix extraction (NO regex_search)
###############################################################################

- name: Extract suffix list safely
  set_fact:
    suffix_list: "{{ last_subnet.name | regex_findall('([0-9]{3})-snt$') }}"

- name: Validate suffix exists
  fail:
    msg: "Subnet name format invalid: {{ last_subnet.name }}"
  when: suffix_list | length == 0

- name: Compute next subnet name
  set_fact:
    next_index: "{{ '%03d' | format((suffix_list[0] | int) + 1) }}"
    new_name: "{{ group_name }}-{{ next_index }}-snt"

###############################################################################
# 5) Utilization check (safe defaults)
###############################################################################

- name: Compute utilization
  set_fact:
    used: "{{ last_subnet.used_ip_count | default(0) }}"
    avail: "{{ last_subnet.available_ip_count | default(0) }}"
    util_pct: "{{ ((used * 100) / (used + avail)) | round(2) if (used + avail) > 0 else 0 }}"

- name: Show utilization
  debug:
    msg: "Utilization {{ util_pct }}% (threshold {{ threshold }}%)"

- name: Skip if utilization below threshold
  meta: end_host
  when: util_pct < threshold

###############################################################################
# 6) CIDR selection (manual subnets auto-skipped)
###############################################################################

- name: Collect used CIDRs
  set_fact:
    used_cidrs: "{{ all_subnets.resources | map(attribute='ipCidrRange') | list }}"

- name: Derive base /16
  set_fact:
    base_net: "{{ last_subnet.ipCidrRange.split('/')[0].split('.')[0:2] | join('.') }}.0.0/{{ auto_base_prefix }}"

- name: Generate candidate subnets
  set_fact:
    candidates: "{{ base_net | ipaddr('subnet', last_subnet.ipCidrRange.split('/')[-1] | int) }}"

- name: Select free subnet
  set_fact:
    free_subnet: "{{ candidates | reject('ipaddr', used_cidrs) | list | first }}"

- name: Fail if no CIDR available
  fail:
    msg: "No free CIDR available for {{ group_name }}"
  when: free_subnet is not defined

###############################################################################
# 7) Create subnet
###############################################################################

- name: Create expanded subnet
  google.cloud.gcp_compute_subnetwork:
    name: "{{ new_name }}"
    project: "{{ gcp_project }}"
    region: "{{ last_subnet.region | regex_replace('.*/', '') }}"
    network: "{{ last_subnet.network }}"
    ip_cidr_range: "{{ free_subnet }}"
