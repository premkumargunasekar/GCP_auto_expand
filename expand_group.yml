---
# expand_group.yml — FINAL FIXED VERSION

###############################################################################
# 1) Get ALL subnets belonging to this prefix
###############################################################################

- name: Get subnets belonging to this prefix
  set_fact:
    group_subnets: >-
      {{
        all_subnets.resources
        | selectattr('name', 'match', ('^' + group_name + '-[0-9]{3}-snt$'))
        | list
      }}

- debug:
    msg: "Group {{ group_name }} subnets: {{ group_subnets | map(attribute='name') | list }}"

###############################################################################
# 2) Skip if no subnets found
###############################################################################

- name: No subnets found → skipping group
  when: group_subnets | length == 0
  debug:
    msg: "Skipping {{ group_name }} — no subnets."

###############################################################################
# 3) Identify last subnet and next number
###############################################################################

- name: Identify last subnet
  when: group_subnets | length > 0
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"

- name: Extract numeric suffix list
  when: group_subnets | length > 0
  set_fact:
    last_num_list: "{{ last_subnet.name | regex_findall('-([0-9]{3})-snt$') }}"

- name: Convert suffix to number
  when: last_num_list | length > 0
  set_fact:
    last_num: "{{ last_num_list[0] | int }}"

# FIXED — condition must check last_num_list
- name: Build next subnet name
  when: last_num_list | length > 0
  set_fact:
    new_num: "{{ '%03d' | format((last_num | int) + 1) }}"
    new_name: "{{ group_name }}-{{ new_num }}-snt"

###############################################################################
# 4) Utilization mock
###############################################################################

- set_fact:
    used: 10
    avail: 246
    util_pct: "{{ (used * 100 / (used + avail)) | float }}"

- debug:
    msg: "Utilization {{ util_pct }}% (threshold {{ threshold }}%)"

- name: Skip expansion (Below threshold)
  when: util_pct < threshold
  debug:
    msg: "Util {{ util_pct }}% < {{ threshold }}% → Not expanding."

###############################################################################
# 5) Only continue if above threshold
###############################################################################

- name: Collect all VPC CIDRs
  when: util_pct >= threshold
  set_fact:
    vpc_cidrs: "{{ all_subnets.resources | map(attribute='ip_cidr_range') | list }}"

- name: Auto derive /16 supernet
  when: util_pct >= threshold
  set_fact:
    ip: "{{ last_subnet.ip_cidr_range.split('/')[0] }}"
    oct: "{{ ip.split('.') }}"
    auto_base: "{{ oct[0] }}.{{ oct[1] }}.0.0/16"
    prefix: "{{ last_subnet.ip_cidr_range.split('/')[-1] }}"

- name: Generate candidate CIDRs
  when: util_pct >= threshold
  set_fact:
    candidate_list: "{{ auto_base | ipaddr('subnet', prefix) }}"

- name: Filter unused CIDRs
  when: util_pct >= threshold
  set_fact:
    free_candidates: "{{ candidate_list | reject('ipaddr', vpc_cidrs) | list }}"

- name: Fail if no CIDRs free
  when: free_candidates | length == 0 and util_pct >= threshold
  fail:
    msg: "No available CIDR for {{ group_name }}"

- name: Select next CIDR
  when: util_pct >= threshold
  set_fact:
    selected_cidr: "{{ free_candidates | first }}"

###############################################################################
# 6) Create new subnet
###############################################################################

- name: Create subnet
  when: util_pct >= threshold
  google.cloud.gcp_compute_subnetwork:
    name: "{{ new_name }}"
    network: "{{ last_subnet.network.split('/') | last }}"
    region: "{{ last_subnet.region.split('/') | last }}"
    ip_cidr_range: "{{ selected_cidr }}"
    project: "{{ gcp_project }}"
  register: create_result

- debug:
    when: util_pct >= threshold
    msg: "Created → {{ new_name }} → {{ selected_cidr }}"
