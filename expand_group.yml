---
# expand_group.yml — FINAL CLEAN VERSION (AWX Compatible)

###############################################################################
# 1. Collect subnets for this group
###############################################################################

- name: Collect subnets for this group
  set_fact:
    group_subnets: >-
      {{
        all_subnets.resources
        | selectattr(
            'name',
            'search',
            '^' + (group_name | regex_escape) + '-[0-9]{3}-snt$'
          )
        | list
      }}

- name: Show group subnets
  debug:
    msg: "Group {{ group_name }} subnets: {{ group_subnets | map(attribute='name') | list }}"

###############################################################################
# 2. Skip if no subnets exist
###############################################################################

- name: Skip group when no subnets found
  debug:
    msg: "Skipping {{ group_name }} – no subnets found"
  when: group_subnets | length == 0

###############################################################################
# 3. Identify last subnet & next name
###############################################################################

- name: Identify last subnet
  set_fact:
    last_subnet: "{{ group_subnets | sort(attribute='name') | last }}"
  when: group_subnets | length > 0

- name: Extract numeric suffix
  set_fact:
    last_num: "{{ (last_subnet.name | regex_search('([0-9]{3})-snt$', '\\1')) | int }}"
  when: group_subnets | length > 0

- name: Compute next subnet name
  set_fact:
    new_num: "{{ '%03d' | format(last_num + 1) }}"
    new_name: "{{ group_name }}-{{ new_num }}-snt"
  when: group_subnets | length > 0

###############################################################################
# 4. Utilization check (safe defaults)
###############################################################################

- name: Calculate utilization
  set_fact:
    used: "{{ last_subnet.used_ip_count | default(0) }}"
    available: "{{ last_subnet.available_ip_count | default(0) }}"
    utilization: >-
      {{
        ((used * 100) / (used + available))
        if (used + available) > 0 else 0
      }}
  when: group_subnets | length > 0

- name: Show utilization
  debug:
    msg: "Utilization for {{ last_subnet.name }}: {{ utilization | round(2) }}%"
  when: group_subnets | length > 0

###############################################################################
# 5. Stop if utilization below threshold
###############################################################################

- name: Skip expansion if utilization below threshold
  debug:
    msg: "Utilization below {{ threshold }}%, skipping expansion"
  when:
    - group_subnets | length > 0
    - utilization < threshold

###############################################################################
# 6. CIDR selection (skip manual subnets)
###############################################################################

- name: Collect used CIDRs in VPC
  set_fact:
    used_cidrs: "{{ all_subnets.resources | map(attribute='ipCidrRange') | list }}"
  when: utilization >= threshold

- name: Derive base /16 automatically
  set_fact:
    base_cidr: >-
      {{
        last_subnet.ipCidrRange.split('.')[0] ~ '.' ~
        last_subnet.ipCidrRange.split('.')[1] ~ '.0.0/' ~ auto_base_prefix
      }}
  when: utilization >= threshold

- name: Generate candidate subnets
  set_fact:
    candidate_subnets: "{{ base_cidr | ipaddr('subnet', last_subnet.ipCidrRange.split('/')[-1] | int) }}"
  when: utilization >= threshold

- name: Select first free CIDR
  set_fact:
    selected_cidr: "{{ candidate_subnets | reject('ipaddr', used_cidrs) | first }}"
  when: utilization >= threshold

###############################################################################
# 7. Create subnet
###############################################################################

- name: Create new subnet
  google.cloud.gcp_compute_subnetwork:
    name: "{{ new_name }}"
    network: "{{ last_subnet.network.split('/') | last }}"
    region: "{{ last_subnet.region.split('/') | last }}"
    ip_cidr_range: "{{ selected_cidr }}"
    project: "{{ gcp_project }}"
  when:
    - utilization >= threshold
    - selected_cidr is defined

- name: Expansion success
  debug:
    msg: "Created subnet {{ new_name }} with CIDR {{ selected_cidr }}"
  when: selected_cidr is defined
