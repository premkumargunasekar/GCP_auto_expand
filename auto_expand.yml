---
- name: Auto Expand Subnets (Main)
  hosts: localhost
  gather_facts: no

  vars:
    threshold: 80
    auto_base_prefix: 16
    suffix_pattern: '-\\d{3}-snt$'
    number_segment_len: 3

    # Regions where your VPCs may have subnets
    regions:
      - asia-south1       # AO
      - europe-west1      # EU
      - asia-east1        # AS
      - us-central1       # NA

  tasks:

    ###########################################################################
    # 1) Fetch ALL subnets across ALL regions (FIX FOR GOOGLE.CLOUD COLLECTION)
    ###########################################################################

    - name: Get subnets from all regions
      google.cloud.gcp_compute_subnetwork_info:
        project: "{{ gcp_project }}"
        region: "{{ item }}"
      loop: "{{ regions }}"
      register: subnet_info

    - name: Merge subnet results
      set_fact:
        all_subnets:
          resources: "{{ subnet_info.results | map(attribute='resources') | flatten }}"

    - name: Extract all subnet names
      set_fact:
        all_names: "{{ all_subnets.resources | map(attribute='name') | list }}"

    ###########################################################################
    # 2) Build group names automatically from subnet name prefix
    #    FIX: renamed "groups" â†’ "subnet_groups" to avoid AWX inventory conflict
    ###########################################################################

    - name: Auto-discover subnet group prefixes
      set_fact:
        subnet_groups: >-
          {{
            all_names
            | map('regex_replace', suffix_pattern, '')
            | unique
            | reject('equalto','')
            | list
          }}

    - name: Debug subnet groups
      debug:
        msg: "Detected subnet groups: {{ subnet_groups }}"

    ###########################################################################
    # 3) Process each group using external task include
    ###########################################################################

    - name: Process subnet group
      include_tasks: expand_group.yml
      loop: "{{ subnet_groups }}"
      loop_control:
        loop_var: group_name
      vars:
        all_subnets_info: "{{ all_subnets }}"
